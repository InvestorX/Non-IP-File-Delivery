/*
 * Non-IP File Delivery - YARA Rules
 * マルウェア検出ルール定義
 */

rule EICAR_Test_File
{
    meta:
        description = "EICAR test file (antivirus test standard)"
        author = "NonIP Security Team"
        date = "2025-10-02"
        severity = "test"
    
    strings:
        $eicar = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"
    
    condition:
        $eicar
}

rule Suspicious_Executable
{
    meta:
        description = "Detects suspicious executable patterns"
        author = "NonIP Security Team"
        date = "2025-10-02"
        severity = "medium"
    
    strings:
        $mz = { 4D 5A }  // MZ header (DOS executable)
        $pe = "PE\x00\x00"
        $suspicious1 = "cmd.exe" nocase
        $suspicious2 = "powershell" nocase
        $suspicious3 = "wscript.exe" nocase
    
    condition:
        $mz at 0 and $pe and any of ($suspicious*)
}

rule Ransomware_Indicators
{
    meta:
        description = "Detects common ransomware indicators"
        author = "NonIP Security Team"
        date = "2025-10-02"
        severity = "critical"
    
    strings:
        $r1 = "encrypted" nocase
        $r2 = "bitcoin" nocase
        $r3 = "decrypt" nocase
        $r4 = "ransom" nocase
        $r5 = ".locked" nocase
        $r6 = ".crypted" nocase
    
    condition:
        3 of them
}

rule SQL_Injection_Patterns
{
    meta:
        description = "Detects SQL injection attempts in file content"
        author = "NonIP Security Team"
        date = "2025-10-02"
        severity = "high"
    
    strings:
        $sql1 = "' OR '1'='1" nocase
        $sql2 = "'; DROP TABLE" nocase
        $sql3 = "UNION SELECT" nocase
        $sql4 = "exec(" nocase
        $sql5 = "xp_cmdshell" nocase
    
    condition:
        any of them
}

rule Webshell_PHP
{
    meta:
        description = "Detects PHP webshell patterns"
        author = "NonIP Security Team"
        date = "2025-10-02"
        severity = "critical"
    
    strings:
        $php1 = "<?php" nocase
        $php2 = "eval(" nocase
        $php3 = "base64_decode" nocase
        $php4 = "system(" nocase
        $php5 = "passthru(" nocase
    
    condition:
        $php1 and 2 of ($php2, $php3, $php4, $php5)
}
